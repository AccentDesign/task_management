$(function(){function readableTextColor(color){var brightStart=123;function hexToRgb(hex){var shorthandRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;hex=hex.replace(shorthandRegex,function(m,r,g,b){return r+r+g+g+b+b});var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}:null}var colourIsLight=function(r,g,b){var a=(r*299+g*587+b*114)/1e3;return a>brightStart};var bgRgb=hexToRgb(color);return colourIsLight(bgRgb.r,bgRgb.g,bgRgb.b)?"black":"white"}function handleAPIError(response){toastr.options={closeButton:true,progressBar:true,positionClass:"toast-bottom-right",timeOut:"10000"};if(response.responseJSON){for(var key in response.responseJSON){console.log(key);if(response.responseJSON.hasOwnProperty(key)){toastr.error(response.responseJSON[key],key)}}}}function getClients(){return $.ajax({type:"GET",url:clientListUrl,data:{for_timesheet:true}})}function getJobs(){return $.ajax({type:"GET",url:jobListUrl,data:{for_timesheet:true}})}function getTasks(){return $.ajax({type:"GET",url:taskListUrl,data:{assignee:currentUser,search:$("[name=search]").val(),for_timesheet:true}})}function buildClientList(show){$.when(getClients(),getJobs(),getTasks()).done(function(clients,jobs,tasks){var clientTree=$("<ul></ul>").addClass("client-list");var jobIds=tasks[0].map(function(o){return o.job}).getUnique();var foundJobs=jobs[0].filter(function(o){return jobIds.includes(o.id)});var clientIds=foundJobs.map(function(o){return o.client}).getUnique();var foundCLients=clients[0].filter(function(o){return clientIds.includes(o.id)});$.each(foundCLients,function(index,client){var clientNode=$('<li data-client-id="'+client.id+'"></li>');var clientLink=$("<a></a>").addClass("client").text(client.name);clientNode.append(clientLink).append("<ul></ul>");clientTree.append(clientNode);var jobsInClient=foundJobs.filter(function(o){return o.client===client.id});$.each(jobsInClient,function(index,job){var jobNode=$('<li data-job-id="'+job.id+'"></li>');if(!show){jobNode.hide()}var jobLink=$("<a></a>").addClass("job").text(job.title);jobNode.append(jobLink).append("<ul></ul>");clientNode.find("ul").first().append(jobNode);var tasksInJob=tasks[0].filter(function(o){return o.job===job.id});$.each(tasksInJob,function(index,task){var taskNode=$('<li data-task-id="'+task.id+'" data-title="'+task.title+'" data-colour="'+job.colour+'"></li>');taskNode.text(task.title).addClass("task").css("background",job.colour).css("color",readableTextColor(job.colour));if(!show){taskNode.hide()}taskNode.draggable({cursor:"move",zIndex:100,revert:true,revertDuration:0,helper:function(event){return $("<div class='task-drag-element'>"+task.title+"</div>")}});jobNode.find("ul").first().append(taskNode)})})});$(".client-list-wrapper").html(clientTree)})}buildClientList(false);$("[name=search]").on("change",function(){var show=$(this).val()!=="";buildClientList(show)});$(document).on("click","[data-client-id] a",function(evt){evt.stopPropagation();$(this).siblings("ul").find("[data-job-id]").toggle()});$(document).on("click","[data-job-id] a",function(evt){evt.stopPropagation();$(this).siblings("ul").find("[data-task-id]").toggle()});var timesheetOptions={defaultView:"agendaWeek",header:{center:"agendaDay,agendaWeek"},height:"parent",firstDay:1,allDaySlot:false,nowIndicator:true,slotEventOverlap:false,slotDuration:{minutes:5},snapDuration:{minutes:1},defaultTimedEventDuration:{minutes:5},scrollTime:moment().format("HH:MM:SS"),editable:true,dragRevertDuration:0,droppable:true,eventOverlap:false,events:function(start,end,timezone,callback){$.ajax({type:"GET",url:timeEntryListUrl,data:{user:currentUser,started_at_after:start.format("YYYY-MM-DD"),started_at_before:end.format("YYYY-MM-DD")},success:function(data){var events=[];$(data).each(function(){events.push({title:$(this).attr("title"),start:$(this).attr("started_at"),end:$(this).attr("ended_at"),id:$(this).attr("id"),task:$(this).attr("task"),comments:$(this).attr("comments"),color:$(this).attr("colour"),duration:$(this).attr("duration"),textColor:readableTextColor($(this).attr("colour"))})});if(callback)callback(events)},error:function(err){console.log(err)}})},viewRender:function(view,element){$.each($(".fc-day-header"),function(key,val){if(timesheetOptions.editable){var input='<label><input type="checkbox"><span></span><em>00:00</em></label>'}else{var input='<label><input type="checkbox" disabled><span></span><em>00:00</em></label>'}$(this).append('<div class="fc-dailycontrol"><div class="checkbox">'+input+"</div></div>")});$.ajax({type:"GET",url:timeDailySignoffUrl,data:{user:currentUser,date_after:view.start.format("YYYY-MM-DD"),date_before:view.end.format("YYYY-MM-DD")},success:function(data){$(data).each(function(){if($(this).attr("completed")===true){$('.fc-day-header[data-date="'+$(this).attr("date")+'"] .fc-dailycontrol input[type=checkbox]').attr("checked","checked")}})}})},eventRender:function(event,element,view){var currentday=moment(event.start).format("YYYY-MM-DD");$(".fc-day-header[data-date="+currentday+"] em").text("00:00")},eventAfterRender:function(event,element,view){var currentday=moment(event.start).format("YYYY-MM-DD");var ctrl=$(".fc-day-header[data-date="+currentday+"] em");if(event.duration){var prev=moment.duration(ctrl.text()||"00:00");var thisEvent=moment.duration(event.duration);var total=thisEvent.add(prev);var formatted=moment.utc(total.asMilliseconds()).format("HH:mm");ctrl.text(formatted)}},eventDestroy:function(event,element,view){var currentday=moment(event.start).format("YYYY-MM-DD");var ctrl=$(".fc-day-header[data-date="+currentday+"] em");if(event.duration&&ctrl.text()!=="00:00"){var prev=moment.duration(ctrl.text()||"00:00");var thisEvent=moment.duration(event.duration);var total=prev.subtract(thisEvent);var formatted=moment.utc(total.asMilliseconds()).format("HH:mm");ctrl.text(formatted)}},drop:function(date,jsEvent){if(!timesheetOptions.editable){return}$.ajax({type:"POST",url:timeEntryListUrl,headers:ajaxHeaders,data:JSON.stringify({task:$(jsEvent.target).data("task-id"),user:currentUser,started_at:date.toISOString(),ended_at:date.clone().add(timesheetOptions.defaultTimedEventDuration.minutes,"minutes").toISOString()}),success:function(data){var event={title:$(data).attr("title"),start:$(data).attr("started_at"),end:$(data).attr("ended_at"),id:$(data).attr("id"),task:$(data).attr("task"),comments:$(data).attr("comments"),color:$(data).attr("colour"),duration:$(data).attr("duration"),textColor:readableTextColor($(data).attr("colour"))};$(".timesheet").fullCalendar("renderEvent",event,false)},error:function(err){console.log(err)}})},eventDrop:function(event,delta,revertFunc,jsEvent){if(!jsEvent.shiftKey){$.ajax({type:"PATCH",url:timeEntryListUrl+event.id+"/",headers:ajaxHeaders,data:JSON.stringify({started_at:event.start.toISOString(),ended_at:event.end.toISOString()}),error:function(err){revertFunc()}})}else{$.ajax({type:"POST",url:timeEntryListUrl,headers:ajaxHeaders,data:JSON.stringify({task:event.task,user:currentUser,started_at:event.start.toISOString(),ended_at:event.start.clone().add(timesheetOptions.slotDuration.minutes,"minutes").toISOString()}),success:function(data){var event={title:$(data).attr("title"),start:$(data).attr("started_at"),end:$(data).attr("ended_at"),id:$(data).attr("id"),task:$(data).attr("task"),comments:$(data).attr("comments"),color:$(data).attr("colour"),duration:$(data).attr("duration"),textColor:readableTextColor($(data).attr("colour"))};$(".timesheet").fullCalendar("renderEvent",event,false)},error:function(err){revertFunc()}});revertFunc()}},eventResize:function(event,delta,revertFunc){$.ajax({type:"PATCH",url:timeEntryListUrl+event.id+"/",headers:ajaxHeaders,data:JSON.stringify({started_at:event.start.toISOString(),ended_at:event.end.toISOString()}),success:function(data){event.duration=$(data).attr("duration");$(".timesheet").fullCalendar("updateEvent",event)},error:function(err){revertFunc();handleAPIError(err)}})},eventClick:function(calEvent){if(!timesheetOptions.editable){return}var pk=calEvent.id;var timesheetOverlay=$(".timesheet-event-overlay");timesheetOverlay.find(".title").html(calEvent.title);timesheetOverlay.find(".overlay-header .color-indicator").css("background-color",calEvent.color);timesheetOverlay.find("[name=task]").val(calEvent.task);timesheetOverlay.find("[name=comments]").val(calEvent.comments);timesheetOverlay.find("[name=start_time]").val(calEvent.start.format("HH:mm"));timesheetOverlay.find("[name=end_time]").val(calEvent.end.format("HH:mm"));timesheetOverlay.addClass("in");timesheetOverlay.find("form").off("submit");timesheetOverlay.find(".close").off("click");timesheetOverlay.find(".delete").off("click");$(document).off("click",".client-list .task");timesheetOverlay.find(".close").on("click",function(){timesheetOverlay.removeClass("in")});timesheetOverlay.find("form").on("submit",function(evt){var task=$(this).find("[name=task]").val();var comments=$(this).find("[name=comments]").val();var startSplit=$("[name=start_time]").val().split(":");var endSplit=$("[name=end_time]").val().split(":");$.ajax({type:"PATCH",url:timeEntryListUrl+calEvent.id+"/",headers:ajaxHeaders,data:JSON.stringify({task:task,started_at:calEvent.start.set({h:startSplit[0],m:startSplit[1]}),ended_at:calEvent.end.set({h:endSplit[0],m:endSplit[1]}),comments:comments}),success:function(data){calEvent.title=$(data).attr("title");calEvent.start=$(data).attr("started_at");calEvent.end=$(data).attr("ended_at");calEvent.id=$(data).attr("id");calEvent.task=$(data).attr("task");calEvent.comments=$(data).attr("comments");calEvent.color=$(data).attr("colour");calEvent.duration=$(data).attr("duration");calEvent.textColor=readableTextColor($(data).attr("colour"));$(".timesheet").fullCalendar("updateEvent",calEvent);timesheetOverlay.removeClass("in")},error:function(err){handleAPIError(err)}});evt.preventDefault()});timesheetOverlay.find(".delete").on("click",function(evt){evt.preventDefault();$.ajax({type:"DELETE",url:timeEntryListUrl+pk+"/",headers:ajaxHeaders,success:function(data){$(".timesheet").fullCalendar("removeEvents",calEvent.id);timesheetOverlay.removeClass("in")},error:function(err){handleAPIError(err)}})});$(document).on("click",".client-list .task",function(evt){var task=$(this).data("task-id");var title=$(this).closest("[data-job-id]").find(".job").text()+" - "+$(this).data("title");var colour=$(this).data("colour");timesheetOverlay.find("[name=task]").val(task);timesheetOverlay.find(".title").html(title);timesheetOverlay.find(".overlay-header .color-indicator").css("background-color",colour);evt.stopPropagation()})}};$(".timesheet").fullCalendar(timesheetOptions);$(document).on("change","[name=timesheet_slot_duration]",function(){timesheetOptions.slotDuration.minutes=$(this).val();$(".timesheet").fullCalendar("destroy");$(".timesheet").fullCalendar(timesheetOptions)});$(document).on("change","[name=timesheet_user]",function(){currentUser=parseInt($(this).val());timesheetOptions.editable=currentUser===loggedInUser||canManageOthers;$(".timesheet").fullCalendar("destroy");$(".timesheet").fullCalendar(timesheetOptions);buildClientList(false)});$(document).on("change",".fc-dailycontrol input[type=checkbox]",function(){var _this=$(this);$.ajax({type:"POST",url:timeDailySignoffUrl,headers:ajaxHeaders,data:JSON.stringify({date:$(_this).closest(".fc-day-header").data("date"),user:currentUser,completed:$(_this)[0].checked}),error:function(err){$(_this)[0].checked=!$(_this)[0].checked}})})});
